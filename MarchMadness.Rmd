---
title: "Final Project"
author: "Team name: F4"
date: "12/16/2018"
output: html_document
runtime: shiny
---

* (Fascinating) Jiayi Ding
* (Fabulous) Lingyun Shao
* (Fantastic) Yangfan Ren
* (Fashionable) Zheng Yuan 


![](https://www.broadcastingcable.com/.image/t_share/MTU0NDg0MDgyMDE1NzQxNDkx/marchmadnesslogo_resized-bc.jpg)



## Part I Background

[NCAA March Madness](https://en.wikipedia.org/wiki/NCAA_Division_I_Men%27s_Basketball_Tournament) is one of the biggest, most exciting and most fun events in all of sports. We could witness the born of many future NBA super stars from this game. Unlike others, this tournament is notorious for upsets and unpredictability. Many people fill out brackets trying to predict the outcome of the tournament, but most have to rip up their bracket after the first few rounds.

There are two ways that a team can earn a bid to the NCAA tournament. The 32 Division I conferences all receive an automatic bid, which they each award to the team that wins the postseason conference tournament. Regardless of how a team performed during the regular season, if they are eligible for postseason play and win their conference tournament, they receive a bid to the NCAA tournament. These teams are known as automatic qualifiers.The second avenue for an invitation is an at-large bid. The selection committee (more on them in a second) convenes on [Selection Sunday](https://www.ncaa.com/news/basketball-men/article/selection-sunday-2019-time-dates-schedule-and-everything), after all regular season and conference tournament games are played, and decides which 36 teams that are not automatic qualifiers have the pedigree to earn an invitation to the tournament.

Duke University's men's basketball team, known as [Duke Blue Devils](http://www.goduke.com/SportSelect.dbml?SPID=1845&SPSID=22724&DB_OEM_ID=4200), is the most popular and traditional athletic teams among students, particularly since 1980 under head coach [Mike Krzyzewski](https://en.wikipedia.org/wiki/Mike_Krzyzewski), who is nicknamed "Coach K". We have won the NCAA Men's Division I Basketball Championship five times, all under Krzyzewski and have been in 16 Final Fours. Seventy-one players have been drafted in the NBA Draft. Additionally, Duke has 19 Atlantic Coast Conference tournament championships, the most of any team in the ACC. 

This year, with talented super star freshmen such as [Zion Willamson](https://en.wikipedia.org/wiki/Zion_Williamson), [R.J.Barret](https://en.wikipedia.org/wiki/R._J._Barrett) as well as head coach [Mike Krzyzewski](https://en.wikipedia.org/wiki/Mike_Krzyzewski), Duke Blue Devils start their exciting new trip. In our final project, we cannot help to know how far we can go this year in NCAA March Madness. (Hope we could win the sixth championship! )

<br/>

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(stringr)
library(shiny)
library(rvest)
library(purrr)
library(httr)
library(XML)
library(tidyverse)
library(ggplot2)
library(grid)
# install.packages('pBrackets')
library(pBrackets)
```

## Part II Sraping NCAA data

The Ken Pomeroy’s college basketball analytics website ([kenpom.com](https://kenpom.com)) provides us with a very good source for obtaining data. They have made available a huge amount of overall analysis data for every NCAA team, every single player or even every single coach extending back to 2003, which is very worth of referencing in our prediction.

However, we met a challenge during the process of scraping data. As the data is not publicaly available, we have to pay for its membership to get access to the valuable data and content. Unlike what we had done to Denny's and La Quinta's website, where we can directly scrape data from, we found that we had to find a way to first login in to our account, and then perform the data scrapping. After reasearching a little bit more into HTML, we tactfully created a `login` function to fill the html form with our account and password information to finally create a login session in html, which would make our following scrapping doable. We also took into consideration of the unstable server connnection to the website, and used `possibly` function to keep getting access to the website in regardless of the connection error during the process. 

Next, we wrote codes to scrape data from the website which includes several lists of analysis data ("Efficiency","Four factors","Team Points Distribution","Miscellaneous Team Stats") and links to data for every team. Using `get_scouting_report` function created by ourselves, we obtained tidy scraped data sets containing every NCAA team as well as all the potential important features for prediction, from year 2016 to 2019. 

Besides, we also sraped the whole season match schedules from 2016 to 2019 utilizing `get_schedule` function generated by ourselves based on `httr` and `stringr` package. These match schedules help us to figure out every matchup in the four tournaments (2016-2019) so that we could generate our training datasets for each year depending on them.

```{r data}
login = function(email = "jiayid@hotmail.com", pw = "523final") {
  url_login = 'https://kenpom.com/register.php?frompage=1'
  # url <- "https://kenpom.com/stats.php?s=RankeFG_Pct"
  session <- html_session(url_login)
  form = html_form(read_html(url_login))[[1]]
  filled_form = set_values(form,
                           email = email,
                           password = pw,
                           remember = TRUE)
  possibly_submit_form = possibly(submit_form, otherwise = NA)
  repeat{
    session = possibly_submit_form(session, filled_form)
    if(all(!is.na(session))) break()
    }
  return(session)
}
#  login using username and pw
session = login()

try_jump_to = function(session, url) {
  pos_jump_to = possibly(jump_to, otherwise = NA)
  repeat{
    res = pos_jump_to(session, url)
    if(all(!is.na(res))) break()
    }
  return(res)
}

get_scouting_report = function(year = 2019) {
# Efficiency and Tempo
  url_year = function(v, year) {paste0(v, '&y=', year)}
  page = try_jump_to(session, "https://kenpom.com/summary.php?s=RankAdjOE" %>% url_year(year)) %>% read_html()
  dt1 = data_frame(
    team = page %>% html_nodes('td:nth-child(1) a') %>% html_text() %>% str_trim(),
    conf = page %>% html_nodes('td+ td a') %>% html_text(),
    AdjTempo = page %>% html_nodes('.td-left:nth-child(3)') %>% html_text() %>% as.numeric(),
    AvgPL_off = page %>% html_nodes('.td-left:nth-child(7)') %>% html_text() %>% as.numeric(),
    AvgPL_def = page %>% html_nodes('.td-left:nth-child(9)') %>% html_text() %>% as.numeric(),
    AdjEff_off = page %>% html_nodes('.td-left:nth-child(11)') %>% html_text() %>% as.numeric(),
    AdjEff_def = page %>% html_nodes('.td-left:nth-child(15)') %>% html_text() %>% as.numeric()
    )
  # Four Factors
  page = try_jump_to(session, "https://kenpom.com/stats.php?s=RankeFG_Pct" %>% url_year(year)) %>% read_html()
  dt2 = data_frame(
    team = page %>% html_nodes('td:nth-child(1) a') %>% html_text() %>% str_trim(),
    eFG_off = page %>% html_nodes('.td-left:nth-child(7)') %>% html_text() %>% as.numeric(), # Effective FG%
    TO_off = page %>% html_nodes('.td-left:nth-child(9)') %>% html_text() %>% as.numeric(), # Turnover %
    OR_off = page %>% html_nodes('.td-left:nth-child(11)') %>% html_text() %>% as.numeric(), # Off. Reb. %
    FTRate_off = page %>% html_nodes('.td-left:nth-child(13)') %>% html_text() %>% as.numeric(), # FTA/FGA
    eFG_def = page %>% html_nodes('.td-left:nth-child(17)') %>% html_text() %>% as.numeric(),
    TO_def = page %>% html_nodes('.td-left:nth-child(19)') %>% html_text() %>% as.numeric(),
    OR_def = page %>% html_nodes('.td-left:nth-child(21)') %>% html_text() %>% as.numeric(),
    FTRate_def = page %>% html_nodes('.td-left:nth-child(23)') %>% html_text() %>% as.numeric()
    )
  # Miscellaneous Team Stats
  page = try_jump_to(session, "https://kenpom.com/teamstats.php?s=RankFG3Pct" %>% url_year(year)) %>% read_html()
  dt3 = data_frame(
    team = page %>% html_nodes('td:nth-child(1) a') %>% html_text() %>% str_trim(),
    Rate3P_off = page %>% html_nodes('.td-left:nth-child(3)') %>% html_text() %>% as.numeric(), # 3P%
    Rate2P_off = page %>% html_nodes('.td-left:nth-child(5)') %>% html_text() %>% as.numeric(), # 2P%
    RateFT_off = page %>% html_nodes('.td-left:nth-child(7)') %>% html_text() %>% as.numeric(), # FT%
    RateBlk_off = page %>% html_nodes('.td-left:nth-child(9)') %>% html_text() %>% as.numeric(), # Blk%
    RateStl_off = page %>% html_nodes('.td-left:nth-child(11)') %>% html_text() %>% as.numeric(), # Stl%
    RateA_off = page %>% html_nodes('.td-left:nth-child(13)') %>% html_text() %>% as.numeric(), # A%/FGM
    Rate3PA_off = page %>% html_nodes('.td-left:nth-child(15)') %>% html_text() %>% as.numeric() # 3PA%/FGA
    )
  page = try_jump_to(session, "https://kenpom.com/teamstats.php?s=RankFG3Pct&od=d" %>% url_year(year)) %>%
    read_html()
  dt4 = data_frame(
    team = page %>% html_nodes('td:nth-child(1) a') %>% html_text() %>% str_trim(),
    Rate3P_def = page %>% html_nodes('.td-left:nth-child(3)') %>% html_text() %>% as.numeric(), # 3P%
    Rate2P_def = page %>% html_nodes('.td-left:nth-child(5)') %>% html_text() %>% as.numeric(), # 2P%
    RateFT_def = page %>% html_nodes('.td-left:nth-child(7)') %>% html_text() %>% as.numeric(), # FT%
    RateBlk_def = page %>% html_nodes('.td-left:nth-child(9)') %>% html_text() %>% as.numeric(), # Blk%
    RateStl_def = page %>% html_nodes('.td-left:nth-child(11)') %>% html_text() %>% as.numeric(), # Stl%
    RateA_def = page %>% html_nodes('.td-left:nth-child(13)') %>% html_text() %>% as.numeric(), # A%/FGM
    Rate3PA_def = page %>% html_nodes('.td-left:nth-child(15)') %>% html_text() %>% as.numeric() # 3PA%/FGA
  )
  # Team Points Distribution
  page = try_jump_to(session, "https://kenpom.com/pointdist.php?s=RankOff_3" %>% url_year(year)) %>% read_html()
  dt5 = data_frame(
    team = page %>% html_nodes('td:nth-child(1) a') %>% html_text() %>% str_trim(),
    D_FT_off = page %>% html_nodes('.td-left:nth-child(3)') %>% html_text() %>% as.numeric(), # FT%
    D_2P_off = page %>% html_nodes('.td-left:nth-child(5)') %>% html_text() %>% as.numeric(), # 2P%
    D_3P_off = page %>% html_nodes('.td-left:nth-child(7)') %>% html_text() %>% as.numeric(), # 3P%
    D_FT_def = page %>% html_nodes('.td-left:nth-child(9)') %>% html_text() %>% as.numeric(), # FT%
    D_2P_def = page %>% html_nodes('.td-left:nth-child(11)') %>% html_text() %>% as.numeric(), # 2P%
    D_3P_def = page %>% html_nodes('.td-left:nth-child(13)') %>% html_text() %>% as.numeric() # 3P%
  )
  # Pomeroy College Basketball Ratings
  page = try_jump_to(session, "https://kenpom.com/index.php?s=RankSOSO" %>% url_year(year)) %>% read_html()
  dt6 = data_frame(
    team = page %>% html_nodes('td.next_left a') %>% html_text() %>% str_trim(),
    Rk = page %>% html_nodes('td.hard_left') %>% html_text() %>% as.numeric(), # Rank
    WL = page %>% html_nodes('td.wl') %>% html_text(),
    AdjEM = page %>% html_nodes('.wl+ td') %>% html_text() %>% as.numeric(), # Adj efficiency margin
    Luck = page %>% html_nodes('.divide:nth-child(12)') %>% html_text() %>% as.numeric(), # Luck rating
    SoS = page %>% html_nodes('.divide:nth-child(14)') %>% html_text() %>% as.numeric(), # Strength of Schedule rating
    Opp_off = page %>% html_nodes('.td-left:nth-child(16)') %>% html_text() %>% as.numeric(), # Average adj OE opposing offense
    Opp_def = page %>% html_nodes('.td-left:nth-child(18)') %>% html_text() %>% as.numeric(), # Average adj DE opposing defense
    NCSoS = page %>% html_nodes('.divide:nth-child(20)') %>% html_text() %>% as.numeric() # Non-conference Strength of Schedule rating
  )
  # Team Roster Stats
  page = try_jump_to(session, "https://kenpom.com/height.php?s=BenchRank" %>% url_year(year)) %>% read_html()
  dt7 = data_frame(
    team = page %>% html_nodes('td:nth-child(1) a') %>% html_text() %>% str_trim(),
    AvgHgt = page %>% html_nodes('td:nth-child(3)') %>% html_text() %>% as.numeric(), # Average Height "
    EffHgt = page %>% html_nodes('td:nth-child(5)') %>% html_text() %>% as.numeric(), # Effective Height "
    CHgt = page %>% html_nodes('td:nth-child(7)') %>% html_text() %>% as.numeric(), 
    PFHgt = page %>% html_nodes('td:nth-child(9)') %>% html_text() %>% as.numeric(),
    SFHgt = page %>% html_nodes('td:nth-child(11)') %>% html_text() %>% as.numeric(),
    SGHgt = page %>% html_nodes('td:nth-child(13)') %>% html_text() %>% as.numeric(),
    PGHgt = page %>% html_nodes('td:nth-child(15)') %>% html_text() %>% as.numeric(),
    Exp = page %>% html_nodes('td:nth-child(17)') %>% html_text() %>% as.numeric(), # Experience yrs
    Bench = page %>% html_nodes('td:nth-child(19)') %>% html_text() %>% as.numeric(), # Bench Minutes %
    Con = page %>% html_nodes('td:nth-child(21)') %>% html_text() %>% as.numeric() # Minitues Continuity %
  )
  # 2-Foul Participation Stats
  page = try_jump_to(session, "https://kenpom.com/foul_trouble.php?s=RankPct2FP" %>% url_year(year)) %>% read_html()
  dt8 = data_frame(
    team = page %>% html_nodes('td:nth-child(1) a') %>% html_text() %>% str_trim(),
    Rate2FP = page %>% html_nodes('td:nth-child(3)') %>% html_text() %>% as.numeric(), # 2-foul participation %
    AdjRate2FP = page %>% html_nodes('td:nth-child(5)') %>% html_text() %>% as.numeric(), # adj 2fp %
  )
  Scouting_Report = dt1 %>%
    left_join(dt2, by = 'team') %>%
    left_join(dt3, by = 'team') %>%
    left_join(dt4, by = 'team') %>%
    left_join(dt5, by = 'team') %>%
    left_join(dt6, by = 'team') %>%
    left_join(dt7, by = 'team') %>%
    left_join(dt8, by = 'team')
  return(Scouting_Report)
}

parse_data = function(year){
  Scouting_Report = get_scouting_report(year)
  data = Scouting_Report %>% 
    mutate(AvgPL = (AvgPL_off + AvgPL_def)/2,
           AdjEff = (AdjEff_off + AdjEff_def)/2,
           eFG = (eFG_off + eFG_def)/2,
           TO = (TO_off + TO_def)/2,
           OR = (OR_off + OR_def)/2,
           FTRate = (FTRate_off + FTRate_def)/2,
           Rate3P = (Rate3P_off + Rate3P_def)/2,
           Rate2P = (Rate2P_off + Rate2P_def)/2,
           RateFT = (RateFT_off + RateFT_def)/2,
           RateBlk = (RateBlk_off + RateBlk_def)/2,
           RateStl = (RateStl_off + RateStl_def)/2,
           RateA = (RateA_off + RateA_def)/2,
           Rate3PA = (Rate3PA_off + Rate3PA_def)/2,
           D_FT = (D_FT_off + D_FT_def)/2,
           D_2P = (D_2P_off + D_2P_def)/2,
           D_3P = (D_3P_off + D_3P_def)/2) %>%
    select(team, conf, AdjTempo, AvgPL, AdjEff, eFG, TO, OR, FTRate, Rate3P, Rate2P, RateFT, 
           RateBlk, RateStl, RateA, Rate3PA, D_FT, D_2P, D_3P, Rk, 
           AvgHgt, Exp, Bench, Con, WL, Luck, SoS,AdjEM, AdjRate2FP) %>%
    mutate(WL = str_split(WL, '-')) %>%
    mutate(WL = sapply(1:nrow(Scouting_Report),
                       function(i) {as.numeric(WL[[i]][1]) - as.numeric(WL[[i]][2])}))
  data
}


# walk(2016:2019, function(i) assign(paste0('data_', i), parse_data(i), envir = .GlobalEnv))
# dir.create('data')
# save downloaded data
# walk(2016:2019, function(i) saveRDS(get(paste0('data_', i)), file = paste0('data/data_', i, '.rds')))
# load downloaded data
walk(2016:2019, function(i) assign(paste0('data_', i), readRDS(file = paste0('data/data_', i, '.rds')), envir = .GlobalEnv))
```


```{r schedule, message = FALSE}
walk(2016:2019,
     function(i) {
       assign(paste0('Teams_', i), get(paste0('data_', i)) %>% pull(team), envir = .GlobalEnv)
       })

get_schedule = function(team, year = 2019) {
  team_recode = team %>% str_replace_all(' ', '+') %>% str_replace_all('&', '%26')
  url_team = paste0('https://kenpom.com/team.php?team=', team_recode, '&y=', year)

  page = try_jump_to(session, url_team) %>% read_html()
  data_frame(
    Team = team,
    # date = page %>% html_nodes('.l td:nth-child(1) a , .un td:nth-child(1) a , .w td:nth-child(1) a') %>% html_text(),
    # Rk = page %>% html_nodes('#schedule-table .seed-gray , .un td:nth-child(2)') %>% html_text() %>% as.numeric(),
    Op = page %>% html_nodes('.w td:nth-child(4) , .l td:nth-child(4) , .un td:nth-child(4)') %>% html_text(), # opponent
    # Op_Rk = page %>% html_nodes('#schedule-table .seed') %>% html_text(), # opponent rank
    Result = page %>% html_nodes('#schedule-table td:nth-child(5)') %>% html_text(), # result
    Loc = page %>% html_nodes('#schedule-table td:nth-child(8)') %>% html_text() , # location
    Record = page %>% html_nodes('#schedule-table td:nth-child(9)') %>% html_text()
    ) %>%
    filter(Loc != "Away" & Loc != "Semi-Away") %>%
    mutate(win = ifelse(str_extract(Result, '^\\w') == 'W', 1, 0),
         net_points = (str_extract(Result, '\\b\\d+') %>% as.numeric()) - 
           str_extract(Result, '\\d+$') %>% as.numeric(),
         net_match = (str_extract(Record, '\\b\\d+') %>% as.numeric()) - 
           str_extract(Record, '\\d+$') %>% as.numeric()) %>% 
    select(-Result)
}

# walk(2016:2019,
#      function(i){
#        tms = get(paste0('Teams_', i)) # teams for year i
#        prog = progress_estimated(length(tms))
#        assign(paste0('Schedule_', i),
#               map_dfr(tms,
#                       function(x) {
#                         prog$tick()$print()
#                         return(get_schedule(x, year = i))
#                         }),
#               envir = .GlobalEnv)
#        cat('\n')
#        print(paste0('Get Schedule_', i))
#        })

# save downloaded schedule
# walk(2016:2019, function(i) saveRDS(get(paste0('Schedule_', i)), file = paste0('data/Schedule_', i, '.rds')))
# load downloaded schedule
walk(2016:2019, function(i) assign(paste0('Schedule_', i), readRDS(paste0('data/Schedule_', i, '.rds')), envir = .GlobalEnv))
```

## Part III Model Structure and Predictions

### Model Structure 
Historically many approaches have been deployed to predict March Madness, ranging from picking teams based on mascot to heavily quantitative predictive models. Building a consistently successful model has proven to be extremely challenging due to the variability that exists in each individual tournament. In this part, we attempted to identify the key regular season characteristics of teams that dictate success in the NCAA tournament. Specifically, we tried out creating probabilistic predictions using three different algorithms : [logistic regression](https://en.wikipedia.org/wiki/Logistic_regression) through the generalized linear model (GLM), a [random forest classifier](https://en.wikipedia.org/wiki/Random_forest) and [gradient boosting machines (GBM)](https://en.wikipedia.org/wiki/Gradient_boosting) with a Bernoulli distribution. As a result, we found that logistic regression worked the best and selected it as our final model.

After looking through several related papers, we found out several parameters for evaluating the level of each team. These are all regular important parameters when we make basketball team assessment. Some interesting examples would be like these:

`Location` - Whether the winning team was playing at home, semi home or on a neutral court

`Offensive Rebound` - Average offensive rebound  per game for a team

`Turnover` - Average turnover  per game for a team

`2P%` - 2-Point Field Goal Percentage

`3P%` - 3-Point Field Goal Percentage

`SOS` - Strength of Schedule; a rating of strength of schedule. The rating is denominated in points above/below average, where zero is average

`AST%`- Assist Percentage. It is an estimate of the percentage of teammate field goals a player assisted while he was on the floor.

`BLK%`- Block Percentage. It is an estimate of the percentage of opponent two-point field goal attempts blocked by the player while he was on the floor.

Depending on the match schedules, we generated our dataframes for year 2016-2018 seperately and used each of them to fit a specific regression model for that year. Then we combined these three models together tactfully by giving different weights on different years, the weights are based on the time series theory. We use three models instead of one, because each year has different features and bugs, and blending them helps to smooth out any rough edges. 

Next the model was enacted versus a different test set – 2019 NCAA regular season results. Surprisingly, the misclassification rate of our final model is only 17%. It did appear that many factors are unimportant, so there’s potential to rerun the model with fewer variables, but in the interest of time that was not enacted in this analysis.

### Predictions

Predictions could be made using our final model. First, we needed to predict the results for the rest of matchups in 2019 NCAA regular season. With this in hand, we could "send our invitations" to 64 teams for "NCAA 2019 March Madness". 

Then predictions were made in the same way as regular seasons in the tournament. One notable difference between the regular season and  tournament is that all games are played on neutral courts in the tournament. We recorded the results of each round (i.e, the teams remained after each round) using lists of lists and build next round's dataframe depending on these lists of lists. This formed a very logical and elegant iterative algorithm. Finally we predicted the results of each round for "NCAA 2019 March Madness" and they were saved in our lists.


```{r prediction, warning=FALSE}
set.seed(109)
parse_var = function(data, schedule) {
  df_vars = data %>%
    left_join(schedule, by=c("team" = "Team")) %>%
    left_join(data %>% select(-conf), by=c("Op" = "team"))
  df_vars_num = df_vars %>% select_if(is.numeric) %>% select(-win, -net_points, -net_match)
  res = df_vars %>%
    select(team, Op:net_match) %>%
    bind_cols(df_vars_num[,1:21]/df_vars_num[,28:48]) %>% 
    bind_cols(df_vars_num[,22:27] - df_vars_num[,49:54]) %>%
    rename_at(vars(contains('.')), funs(str_remove(., '\\.\\w$'))) %>%
    filter(!is.na(WL))
  return(res)
}

walk(2016:2019,
     function(i) {
       assign(paste0('df_', i),
              parse_var(get(paste0('data_', i)),
                        get(paste0('Schedule_', i))),
              envir = .GlobalEnv)  
       })

# 2019 matches that already happened
df_2019_comp = df_2019 %>% filter(!is.na(net_match))
# 2019 matches that have not happened yet
df_2019_tobepred = df_2019 %>% filter(is.na(net_match))

model_var = function(df) {
  df %>% select(-team, -Op, -Record, -net_points, -net_match)
}

glm_2016 = glm(win ~ ., data = model_var(df_2016), family = binomial())
glm_2017 = glm(win ~ ., data = model_var(df_2017), family = binomial())
glm_2018 = glm(win ~ ., data = model_var(df_2018), family = binomial())

# weighting predictions
prediction = function(x, a = 0.4){
  pre_16 = predict(glm_2016, newdata = x, type = "response")
  pre_17 = predict(glm_2017, newdata = x, type = "response")
  pre_18 = predict(glm_2018, newdata = x, type = "response")
  pre = (1/(1+a+a^2)) * pre_18 + (a/(1+a+a^2)) * pre_17 + (a^2/(1+a+a^2)) * pre_16
  pre1 = as.data.frame(pre) %>% mutate(win = ifelse(pre > 0.5, 1, 0)) %>% 
    cbind(.,x$team, x$Op)
  pre1 = pre1 %>% select(c(3,4,2))
  colnames(pre1) = c("team", "Op", "win")
  pre1
}

pre_2019 = prediction(df_2019_tobepred)

WL_comp = df_2019_comp %>% group_by(team) %>% summarise(sum1 = sum(win == 1), sum0 = sum(win == 0)) %>%
  mutate(WL = sum1 - sum0) %>% select(c(1,4))
WL_pre1 = pre_2019 %>% group_by(team) %>% summarise(sum1 = sum(win == 1), sum0 = sum(win == 0)) %>%
  mutate(WL = sum1 - sum0) %>% select(c(1,4))
WL_pre2 = pre_2019 %>% group_by(Op) %>% summarise(sum1 = sum(win == 0), sum0 = sum(win == 1)) %>%
  mutate(WL = sum1 - sum0) %>% select(c(1,4))
colnames(WL_pre2) = c("team", "WL")
WL_2019 = left_join(WL_pre1, WL_pre2, by = c("team" = "team")) %>% 
  left_join(WL_comp, by = c("team" = "team")) %>% 
  mutate(WL = ifelse(is.na(WL), 0, WL), count = (WL.x + WL.y + WL)) %>%
  arrange(desc(count)) %>%
  select(c(1,5)) %>%
  slice(1:64)

South= data.frame(team = c( "Virginia", "Creighton", "Davidson", "Arizona", 
                            "Buffalo", "Loyola Marymount", "Tennessee", "Nevada", 
                            "Texas Southern", "Cincinnati", "Georgia St.", "VCU", 
                            "Wofford", "Georgia Southern", "Howard", "Temple"))
West = data.frame(team = c( "Florida St.", "South Dakota St.", "Gonzaga", "UNC Greensboro",
                            "Houston", "Michigan", "Montana", "North Carolina", 
                            "Lipscomb", "UC Irvine", "Toledo", "Fresno St.",
                            "Utah Valley","Washington","Nebraska","San Francisco"))
East = data.frame(team = c("Stony Brook", "Villanova", "Virginia Tech", "Murray St.",
                           "Holy Cross" ,"Marquette", "St. Francis PA","Vermont",
                           "Belmont","Wisconsin","Dayton","Lehigh",
                           "Yale","Duquesne","Northeastern", "Rider"))
Midwest = data.frame(team = c("Kansas","New Mexico St.","Auburn","Charleston",
                              "Syracuse", "Michigan St.", "Oklahoma","Duke",
                              "Ball St.","Louisiana", "Northern Kentucky", "Western Kentucky",
                              "Mississippi St.","Indiana","Northern Colorado", "Weber St."))

South1 = left_join(South, WL_2019, by=c("team" = "team")) %>% arrange(desc(count))
West1 = left_join(West, WL_2019, by=c("team" = "team")) %>% arrange(desc(count))
East1 = left_join(East, WL_2019, by=c("team" = "team")) %>% arrange(desc(count))
Midwest1 = left_join(Midwest, WL_2019, by=c("team" = "team")) %>% arrange(desc(count))

opp = function(x){
  y = x[c(1,8,5,4,6,3,7,2,15,10,14,11,13,12,9,16),]
  y = y %>% mutate(Op = rev(y$team), Loc = rep("Neutral", nrow(y))) %>% select(-count) %>% slice(1:8)
  y
}

first_rnd = list(South = opp(South1), West = opp(West1), East = opp(East1), Midwest = opp(Midwest1))

get_opp = function(data, op) {
  df_vars = op %>%
    left_join(data, by=c("team" = "team")) %>%
    left_join(data, by=c("Op" = "team")) %>% select(-conf.x,-conf.y)
  res = df_vars %>%
    bind_cols(df_vars[,4:25]/df_vars[,31:52]) %>% 
    bind_cols(df_vars[,26:30] - df_vars[,53:57]) %>% 
    select(c(1:3, 58:84)) %>%
    rename_at(vars(contains('.')), funs(str_remove(., '\\.\\w\\d$'))) %>%
    filter(!is.na(WL))
  return(res)
}

opp1 = function(x){
  n = nrow(x)
  vector = 1:n
  y = data.frame(team = x[c(vector[seq(n) %% 2 == 1], rev(vector[seq(n) %% 2 == 0])),])
  y = y %>% mutate(Op = rev(y$team), Loc = rep("Neutral", nrow(y))) %>% slice(1:(n/2))
  y
}

get_new_opp = function(data, rnd){
  map(1:4, function(x){
    pre = prediction(get_opp(data, rnd[[x]]))
    pre1 = data.frame(team = ifelse(pre$win == 1, as.character(pre$team), as.character(pre$Op)))
    opp1(pre1)
  })
}

snd_rnd = get_new_opp(data_2019, first_rnd)
third_rnd = get_new_opp(data_2019, snd_rnd)
fourth_rnd = get_new_opp(data_2019, third_rnd)
final_four = get_new_opp(data_2019, fourth_rnd)

final_four_data = data.frame(team = c(as.character(final_four[[1]]$team), as.character(final_four[[2]]$team)),
                             Op = c(as.character(final_four[[3]]$team), as.character(final_four[[4]]$team)),
                             Loc = rep("Neutral", 2))

pre_final = prediction(get_opp(data_2019, final_four_data))
pre_final1 = data.frame(team = ifelse(pre_final$win == 1, as.character(pre_final$team), as.character(pre_final$Op)))
final = data.frame(team = pre_final1[1,], Op = pre_final1[2,], Loc = "Neutral")
pre_champ = prediction(get_opp(data_2019, final))
pre_champ1 = data.frame(team = ifelse(pre_champ$win == 1, as.character(pre_champ$team), as.character(pre_champ$Op)))

get_list = function(x){
  l = c()
  for(j in 1:4){
    for(i in 1:nrow(x[[1]])){
      if(x[[j]][i,1] != x[[j]][i,2]){
        l = c(l, as.character(x[[j]][i,1]), as.character(x[[j]][i,2]))
      }
      else{
        l = c(l, as.character(x[[j]][i,1]))
      }}}
  l
}

prediction_final = list(get_list(first_rnd), get_list(snd_rnd), get_list(third_rnd), 
                        get_list(fourth_rnd), get_list(final_four), c(as.character(final[,1]), as.character(final[,2])),
                        as.character(pre_champ1[,1]))

## check prediction accuracy
check = prediction(df_2019_comp)
mean(check$win != df_2019_comp$win)

```

## Part IV Shiny App

![](https://websterapartments.org/wp-content/uploads/2015/03/MarchMadness-main.jpg)

We decided to visualize our prediction results as well as analysis data to the general public by designing an elaborate Shiny App through `shiny` package in R. The whole shiny program is mainly seperated into 3 parts, the `Prediction Bracket`, `Round-by-round Probabilities Table` and `Teams Comparison`. 

In `Perdiction Bracket` part, what we wanted is that users could explore each stage of the prediction bracket by themselves through pressing the button in the user interface cause this would add a lot more fun to displaying the results. If our users are eager to get final result, however, there is also a button designed for this situation so that they could see all the results with only one single press.

In `Round-by-round Probabilities Table` part, we want to provide our users with a neatly organized table including the chance of reaching each round for every team in the tournament, i.e., how far each team could go in "NCAA 2019 March Madness" based on our predictions.

In `Teams Comparison` part, we provide our users with a place where they could compare any two teams' any aspects of analysis data that they are interested in. In the side panel, users are able to specify any two different teams they want to learn about in two select input boxes and specify any parameters they want to compare in check input box so that the main panel could display the corresponding data. Besides, the users are also able to click on any of the team names in the returned table and this will link them to that team's page on NACC official website.


<style type="text/css">
.shiny-frame{
  width: 100%;
  height: 1200px;
}
</style>

<br>
<br>

```{r reaching round table}
team64 = prediction_final[[1]]
tournament = data_frame(Teams = team64, `1 ST` = 0, `2 ND` = 0, `SWEET 16` = 0, `ElITE EIGHT` = 0, `FINAL FOUR` = 0, `CHAMP.` = 0, WIN = 0)
nrnd = 7
remaining = function(x){
  map(1:nrnd, function(i) {ifelse(x%in%prediction_final[[i]],1,0)}) %>% unlist
}

tournament[, 2:(1+nrnd)] = matrix(unlist(map(team64,remaining)),ncol=7,byrow=TRUE)

tournament = tournament%>%
              mutate(rs = rowSums(.[2:(1+nrnd)]))%>%
              arrange(desc(rs), Teams)%>%
              select(-rs)
tournament[, 2:(1+nrnd)] = ifelse(tournament[, 2:(1+nrnd)] == 1, '✓', '-')
```


```{r shiny app}
bracketsGrob <- function(...){
  l <- list(...)
  e <- new.env()
  e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
}

plot_rnd = function(rnd, prediction) {
  p = ggplot(x = 1, y = 1) + theme_bw()
  RT = c('1ST ROUND', '2ND ROUND', 'SWEET 16', 'ELITE 8', 'FINAL 4', 'CHAMPIONSHIP')
  if(rnd == 0) return(p)
  if(rnd >= 8) rnd = 7
  e = environment()
  for (r in 1:rnd) {
    if(r <= 5) {
      teams = prediction[[r]]
      n = 2^(5-r)
      walk(1:n,
           function(i) {
             assign(paste0('l', i),
                    bracketsGrob(unit(0.01 + 0.08 *(r-1),'npc'),
                                 unit(0.96 - 0.015 * (2^r/2 - 1) - 0.06 * 2^(r-1) * (i - 1), 'npc'),
                                 unit(0.01 + 0.08 *(r-1),'npc'),
                                 unit(0.96 - 0.03 * 2^(r - 1) - 0.015 * (2^r/2 - 1) - 0.06 * 2^(r-1) * (i - 1),'npc'),
                                 h=0.16, type =4, ticks = NA), envir = e)
             assign(paste0('r', i),
                    bracketsGrob(0.99 - 0.08 *(r-1), 0.96 - 0.03 * 2^(r - 1) - 0.015 * (2^r/2 - 1) - 0.06 * 2^(r-1) * (i - 1),
                                 0.99 - 0.08 *(r-1), 0.96 - 0.015 * (2^r/2 - 1) - 0.06 * 2^(r-1) * (i - 1),
                                 h=0.16, type =4, ticks = NA), envir = e)
           })
      walk(1:n, function(i) {assign('p',
                                    p + 
                                      annotation_custom(get(paste0('l',i))) + 
                                      annotation_custom(get(paste0('r',i))),
                                    envir = e)
      })
      
      tx = textGrob(teams,
                    x = unit(rep(c(0.05 + 0.08 * (r - 1),0.95 - 0.08 * (r - 1)), each = n*2), "npc"),
                    y = unit(rep(seq(0.97 - 0.015 * (2^r/2 - 1),0.04 + 0.015 * (2^r/2 - 1),length.out = n*2), 2), "npc"),
                    gp=gpar(fontsize=8))
      rt = textGrob(RT[r],
                    x = unit(c(0.05 + 0.08 * (r - 1),0.95 - 0.08 * (r - 1)), "npc"),
                    y = unit(0.99, "npc"),
                    gp=gpar(fontsize=8, col = 'gray'))
      conf = textGrob(c('SOUTH', 'WEST', 'EAST', 'MIDWEST'),
                    x = unit(c(0.25, 0.25, 0.75, 0.75), "npc"),
                    y = unit(c(0.735, 0.245, 0.735, 0.245), "npc"),
                    gp=gpar(fontsize=8, col = 'gray'))
      p = p + annotation_custom(tx) + annotation_custom(rt) + annotation_custom(conf)
    } else if (r == 6) {
      teams = prediction[[r]]
      p = p + 
        annotation_custom(
          linesGrob(x = unit(c(0.41, 0.59), "npc"),
                    y = unit(c(0.495, 0.495), "npc"))
        ) +
        annotation_custom(
          textGrob(teams,
                   x = unit(c(0.05 + 0.08 * (r - 1),0.95 - 0.08 * (r - 1)), "npc"),
                   y = unit(0.505, "npc"),
                   gp=gpar(fontsize=8))
        ) +
        annotation_custom(
          textGrob(RT[r],
                   x = unit(0.5, "npc"),
                   y = unit(0.99, "npc"),
                   gp=gpar(fontsize=8, col = 'gray'))
        )
    } else {
      teams = prediction[[r]]
      p = p + 
        annotation_custom(
          linesGrob(x = unit(c(0.5, 0.5), "npc"),
                    y = unit(c(0.495, 0.6), "npc"))
        ) +
        annotation_custom(
          textGrob(teams,
                   x = unit(0.5, "npc"),
                   y = unit(0.62, "npc"),
                   gp=gpar(fontsize=13))
        )
    }
  }
  return(p)
}

library(shiny)
library(shinythemes)

ui = fluidPage(
  theme = shinytheme('sandstone'),
  # themeSelector(),
  navbarPage(
    title = "Dark Sky Weather Forecast",
    id = 'nav',
    tabPanel('Prediction Bracket', value = 'Bracket',
             fluidRow(
               column(4, actionButton('fetch', 'Click to see next round')),
               column(4, actionButton('final', 'Click to see all predictions')),
               column(4, actionButton('reset', 'Click to reset'))
             ),
             plotOutput('brac', width = "100%")
    ),
    tabPanel('Prediction Table', value = 'Table',
             fluidRow(
               column(3),
               column(9, h3('CHANCE OF REACHING ROUND'))
             ),
             fluidRow(
               column(12, tableOutput("tab"))
             )
    ),
    tabPanel('Teamwise Stats', value = 'Stats',
             sidebarLayout(
               sidebarPanel(
                 selectInput("team", label = h3("Pick your team"), 
                             choices = prediction_final[[1]], 
                             selected = "Duke"),
                 selectInput("op", label = h3("Pick your opponent"), 
                             choices = prediction_final[[1]], 
                             selected = "North Carolina"),
                 actionButton("run", "Compare Stats"),
                 h3(helpText("Pick the stats you want to compare")),
                 checkboxGroupInput("comp", "Comprehensive stats",
                                    choices = colnames(data_2019)[c(20,26:29,3:5)], selected = colnames(data_2019)[c(20,26:29,3:5)]),
                 checkboxGroupInput("ff", "Four Factors",
                                    choices = colnames(data_2019)[6:9], selected = colnames(data_2019)[6:9]),
                 checkboxGroupInput("mis", "Miscellaneous Components",
                                    choices = colnames(data_2019)[10:16], selected = colnames(data_2019)[10:16]),
                 checkboxGroupInput("pd", "Point Distribution",
                                    choices = colnames(data_2019)[17:19], selected = colnames(data_2019)[17:19]),
                 checkboxGroupInput("person", "Personnel",
                                    choices = colnames(data_2019)[21:24], selected = colnames(data_2019)[21:24]),
                 helpText("You can find explanation of these terms on https://kenpom.com/blog/help-with-team-page/"),
                 width = 3
                 
               ),
               mainPanel(
                 fluidRow(
                   column(6, uiOutput("link1")),
                   column(6, uiOutput("link2"))
                 ),
                 DT::dataTableOutput("team")
                 
               )
             ))
  )
)

server = function(input, output, session)
{
  round = reactiveValues(r = 0)
  
  observeEvent(input$final, {
    round$r = 7
  })
  
  observeEvent(input$reset, {
    round$r = 0
  })
  
  observeEvent(input$fetch, {
    round$r = round$r + 1
  })
  GetPlot = reactive({plot_rnd(round$r, prediction_final)})

  output$brac <- renderPlot({
    GetPlot()
  }, height = 440, width = 880)
  
  output$tab = renderTable({tournament})
  
  
  all_teams = rbind(South, West, East, Midwest)
  stats = left_join(all_teams, data_2019, by = c("team" = "team"))
  
  get_stats = function(Team1, Team2) {
    team1_stats = subset(stats, team == Team1)
    team2_stats = subset(stats, team == Team2)
    data.frame(rbind(team1_stats, team2_stats))
  }
  
  name = function(team) {
    if(team == "Georgia Southern"){
      n = "ga-southern"
    }
    else if(team == "Western Kentucky"){
      n = "western-ky"
    }
    else if(team == "Louisiana"){
      n = "louisiana-tech"
    }
    else if(team == "Northern Kentucky"){
      n = "northern-ky"
    }
    else if(team == "Charleston"){
      n = "charleston-so"
    }
    else if(team == "Northern Colorado"){
      n = "northern-colo"
    }
    else{
      n = team %>% tolower() %>% str_remove("\\.") %>% str_replace(" ", "-")
    }
    n
  }
  
  
  observeEvent(input$run, {
    
    url1 = paste0("https://www.ncaa.com/schools/", name(input$team))
    url2 = paste0("https://www.ncaa.com/schools/", name(input$op))
    output$link1 = renderUI({tagList(a(h3(input$team), href = url1, target = "_blank"))})
    output$link2 = renderUI({tagList(a(h3(input$op), href = url2, target = "_blank"))})
    
    output$team = DT::renderDataTable({
      data = t(get_stats(input$team, input$op)[, c(input$comp, input$ff, input$mis, input$pd, input$person)])
      colnames(data) = c(input$team, input$op)
      DT::datatable(data)
    })
  })
  
}

shinyApp(ui, server)
```

To check the shiny App, please render the Rmd file.


## Part V Last of Last
In our predictions, Kansas would win the NCAA Men's Division I Basketball Championship. So we hope our prediction is wrong :). <br/>
Let's go for Duke!


